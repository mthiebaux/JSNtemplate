<!DOCTYPE html>
<html>

	<head>

		<title>storage client</title>

		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<script type="module">

			window.addEventListener(
				'load',
				function() {

					const local_storage_app_key = "jsntemplate-storage-app";
//					const local_storage_app_key = "jsntemplate-storage-appX";

/////////////////////////////////

if( 0 )	{
					localStorage.clear();
}
if( 0 )	{
			// run once after clearing website-data from browsers
					function profile_testing_setup()	{

						localStorage.clear();
						let app_storage_obj = {
							profiles:	{
								"A": {
									"registration":	"a07d4b07-fd03-4587-84f1-ef6795a8afd9",
									"session":		"fb047635-c3ba-4624-97bf-ec32576b4b9f"
								},
								"B": {
									"registration":	"7853b338-736c-4484-bd0d-f520fc6477c9",
									"session":		""
								}
							}
						};
						localStorage.setItem( local_storage_app_key, JSON.stringify( app_storage_obj ) );
					}
					profile_testing_setup();
}
/////////////////////////////////

					function init_local_storage_profiles()	{ // create if none exists

						if( localStorage.getItem( local_storage_app_key ) === null )	{

							console.log( "Creating new storage: " + local_storage_app_key );

							localStorage.setItem(
								local_storage_app_key,
								JSON.stringify( { profiles: {} } )
							);
						}
					}
					init_local_storage_profiles(); // ensure it exists

					function add_local_storage_profile( name )	{

						let app_storage_obj = JSON.parse( localStorage.getItem( local_storage_app_key ) );

						if( app_storage_obj.profiles.hasOwnProperty( name ) )	{

							output_log( "ERR: name exists: " + name );
						}
						else	{

							app_storage_obj.profiles[ name ] = {
								registration: "",
								session: ""
							};
							localStorage.setItem(
								local_storage_app_key,
								JSON.stringify( app_storage_obj )
							);
						}
						return( app_storage_obj.profiles[ name ] );
					}
					function get_local_storage_profile( name )	{

						let app_storage_obj = JSON.parse( localStorage.getItem( local_storage_app_key ) );

						if( app_storage_obj.profiles.hasOwnProperty( name )	)	{

							return( app_storage_obj.profiles[ name ] );
						}
						return( null );
					}

					function update_profile_field( name, field, uuid )	{

						let app_storage_obj = JSON.parse( localStorage.getItem( local_storage_app_key ) );

						if( app_storage_obj.profiles.hasOwnProperty( name )	)	{

							let profile = app_storage_obj.profiles[ name ];
							profile[ field ] = uuid;

							localStorage.setItem(
								local_storage_app_key,
								JSON.stringify( app_storage_obj )
							);
							return;
						}
						output_log( "Update \'" + field + "\' ERR: name does not exist: " + name );
					}

					function print_local_storage()	{

						let app_storage_obj = JSON.parse( localStorage.getItem( local_storage_app_key ) );
						output_log( app_storage_obj );
					}

					function submit_conn_button()	{

						let name = document.getElementById( "name_buffer" ).value.trim();
						if( name )	{
							let profile = get_local_storage_profile( name );
							if( profile === null )	{

								output_log( "Creating new profile: " + name );
								profile = add_local_storage_profile( name );
							}
							output_log( "Connect: " + name );
							output_log( profile );
						}
						else	{
							output_log( "ERR: non-empty name string required" );
						}
					}

					function output_log( output_obj )	{

						let log_area = document.getElementById( "output_log" );
						log_area.value += JSON.stringify( output_obj, null, 4 );
						log_area.value += '\n';
						log_area.scrollTop = log_area.scrollHeight;
					}

					document.getElementById( "conn_button" ).addEventListener(
						'click', submit_conn_button );

					document.getElementById( "storage_button" ).addEventListener(
						'click', print_local_storage );

					output_log( "HELLO" );


//					update_profile_field( "D", "registration", "XXX" );

				}
			);

		</script>

	</head>

	<body>

		<div class="page_header">
			<h1><em>Storage</em> Client <div id="client_index" style="display: inline;"></div></h1>
		</div>

		<div id="page_contents">

			input:<br>
			<input id="name_buffer"
				type="text"
				placeholder="your name"
				size="15em"></input>
			<button id="conn_button">connect</button>
			<button id="storage_button">storage</button>
			<p>

			log:
			<br>
			<textarea id="output_log" readonly=true rows="12" cols="60"></textarea>

		</div>

		<div class="page_footer">
			<p>
			<em> Â© thiebaux 2022 </em>
		</div>

	</body>
</html>
